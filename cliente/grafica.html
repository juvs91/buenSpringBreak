<!DOCTYPE html>
<html ng-app>
	<head>
		<script type="text/javascript" src="plugins/jquery.min.js"></script> 
		<script src="plugins/highcharts.js"></script>     
		<script type="text/javascript" src="js/sensores.js" charset="utf-8"></script>                                                        
		<script type="text/javascript" src="js/point.js" charset="utf-8"></script>                 
		<script type="text/javascript" src="js/request.js" charset="utf-8"></script> 
		<script type="text/javascript" src="js/cargaForma.js" charset="utf-8"></script>  
		<script type="text/javascript" src="js/altasBajasCambios.js"></script>
		<script src="js/Cargar.js"></script>  
		<link href="css/bootstrap.min.css" rel="stylesheet">
	    <link href="css/forms.css" rel="stylesheet">
	</head>
	<body id="body" >             
		<button type="button" class="btn btn-primary  " id = "btn-form-modify">modificar sensor</button>  
		<button type="button" class="btn btn-danger  " id = "btn-form-delete">borrar un sensor</button>
		<div id='container' ></div>  
		<div id="form"></div> 
		<button type="button" class="btn btn-primary btn-block" id = "btn-form-create" >crear sensor</button>  
		
	</body>                        
	<script type="text/javascript" charset="utf-8">
    /*
    	falta hacer un refactor de cambiar todo el codigo en ingles y checar que el sensor pueda pedir los puntos por id y desde el mapa, consultarlo con el equipo
	*/
	var sensoresJson = requestSensores(); 
	var sensor; 
	var allSeries = [];   
	var chart; //variable chart para que se actualize en tiempo real 
	var shift;//la variable que se encarga si se tiene que mover la grafica  
	var idSeriesMap = {  }; //para saber que sensor corresponde a que posision del arreglo    
	var sensorsPointsMap = { null:{}};                
	var j = 0;         
	var displayedSensors = []; //actualemente no se encuentran sensores seleccionados 
	var actualTypeSensor = null; //es el tipo de sensor actualmente   
	var pos = -1;     
	var hasToggleByButton = false;
	
	//se agregan la forma y se oculta para que no e vea pero este disponible para el toggle 
    $("#form").append(forma).hide(); 


	for(t = sensoresJson.length; j < t; j++) {
		allSeries.push((creaSensor(sensoresJson[j],j)).getDataStructureGraph());
	}           
	chart = new Highcharts.Chart({
		chart :{
			renderTo :"container",
			defaultSeriesType: 'line',
			},
		title :{
			text : "todos los sensores"
		},
		xAxis :{
			type : "datetime", 
			tickPixelInterval: 150,
			maxZoom: 20 * 1000
		},
		yAxis : {
			minPadding : 0.2,
			maxPadding : 0.2,
			title : {
				text : "",
				margin : 80
			}
		}, 
		series : allSeries,
        plotOptions : {
			series : {
				events: {
					show :function(e){//se detecta cuando una serie es seleccionada 
						selectSerie(e["target"])
						//console.log(e);
					},
					hide:function  (e) {
						deSelectSerie(e["target"]); 
					} 
				},
			},
		},
	});          
   
	function selectSerie(serie){
		//console.log(serie);     

		if (serie.options.id == actualTypeSensor && serie.options.id != null) {
			displayedSensors.push(serie);//se guarda el sensor en la lista de sensores desplegados
			if (hasToggleByButton){
				hasToggleByButton = false;
			}
		}else{
			if (hasToggleByButton){
				displayForm(null);
				hasToggleByButton = false;
			}
			hideAllSensors();
			//displayedSensors = [];//se borran los sensores acumulados
			actualTypeSensor = serie.options.id;//se cambia el sensor que se va a desplegar 
			displayedSensors.push(serie);//se guarda el sensor en la lista de sensores desplegados
			if (serie.options.id) {
				if ((serie.options.id).toLocaleLowerCase() == "gas") {
					chart.yAxis[0].setTitle({text : "PPM"})
				}else{
					chart.yAxis[0].setTitle({text : "temperatura"})
				}
			}else{ 
				chart.yAxis[0].setTitle({text : ""})
			}
		}
		if (serie.options.id == null ){ 
			if (hasToggleByButton) {
				//$("#form-create").slideToggle();//one toggle to put the other clicked sensor 
				//displayForm(serie);  
				fillForm(serie); 
				hasToggleByButton = false;
			}else{
				displayForm(serie);
			}    
		}
	}   
	
	
	//funcion que despliega la forma de crear
	$("#btn-form-create").click(function() {  
		if (hasToggleByButton){
			displayForm(null);
			hideAllSensors();
			hasToggleByButton = false;
		}else{
			displayForm(null);
			hideAllSensors();
			hasToggleByButton = true;
		}
	});                
	
	//funcion que despliega la forma de modificar
	$("#btn-form-modify").click(function () { 
		if (displayedSensors.length == 1 && displayedSensors[0].options.id != null) {
		   	displayForm (displayedSensors[0]);//el unico sensor que esta en la lista 
		   	if(hasToggleByButton){ 
		   		hasToggleByButton=false;
		   	}
			else hasToggleByButton = true;
		}
	}); 
	//funcion que despliega la forma de borrar
	$("#btn-form-delete").click(function () { 
		if (displayedSensors.length == 1) {
		   	deleteSensor(displayedSensors[0]);//el unico sensor que esta en la lista
		}
	});
	                
	function deSelectSerie (serie) {  
		
		if (serie.options.id == null) {
			displayForm(null);  
		}
		else if (hasToggleByButton){
			displayForm(null);
			hasToggleByButton = false;
		}	
		pos = displayedSensors.indexOf(serie);
		if (pos > -1) { 
			displayedSensors.splice(pos,1)[0]; 
			pos = -1;
		}
		//displayedSensors.pop(serie);
	}
	function hideAllSensors () {
		for (var i = displayedSensors.length - 1; i >= 0; i--){
			displayedSensors.pop().hide();
		};
	}
	
	 
	//esta funcion tiene que llenar los puntos 
	function graphPoints(newPoints) { 
		for (var i = 0; i < newPoints.length; i++) {
			if (sensorsPointsMap[newPoints[i]["sensor_tag"]]) {
				 if (!(sensorsPointsMap[newPoints[i]["sensor_tag"]][newPoints[i]["slId"]])) {
				   pushPoints(newPoints[i]);
			     }
			}else{//se crear e sensor 
			   addSeries(newPoints[i]); 
			}
		}                                                                                           

	}   
	
	function pushPoints (newPoint) {
		 //mueve la grafica o no 
		 shift = chart.series[idSeriesMap[newPoint["sensor_tag"]]].data.length > 58;  
		 //agrega los puntos a la grafica
		 //tengo que agregar el punto a la serie y pasarle por parametro 
		 chart.series[idSeriesMap[newPoint["sensor_tag"]]]
			  .addPoint([newPoint["slActualTimestamp"]
			  ,newPoint["slActualValue"]],shift,true); 
  	}
	    
	function addSeries (serie) {
		chart.addSeries((creaSensor(serie,j)).getDataStructureGraph());
		j++;
   	}
	
	function llenaSensoresPuntos(mapa) {  
		if (mapa["sensor_tag"]) {
			sensorsPointsMap[mapa["sensor_tag"]] = {};
			sensorsPointsMap[mapa["sensor_tag"]][mapa["slId"]] = mapa["slId"];
		}else{                                                        
			sensorsPointsMap[null][mapa["slId"]] = mapa["slId"]; 
			
		}
	}
  
	function creaSensor (sensorJson,posArreglo) {
		sensor =new Sensores();   
		sensor.setTag(sensorJson["sensor_tag"]); 
		sensor.setType(sensorJson["sensor_type"]); 
		if (sensorJson["sensor_tag"]) {
		  	sensor.setSensorName(sensorJson["sensor_tag"]); 
		}else{                             
			sensor.setSensorName("slId "+sensorJson["slId"]);
		}                                                
		llenaSensoresPuntos(sensorJson); 
   	    sensor.addPoint(sensorJson["slActualValue"]
						,sensorJson["slActualTimestamp"]
						,sensorJson["slId"]
						,sensorJson["sensor_type"]);
		//slId tiene el ultimo punto de la tabla sensorlist				
   		idSeriesMap[sensor.getTag()] = posArreglo;  
		return sensor;
	}	
		
	setInterval(function(){requestNewPoints()},5000);

	</script>
</html>