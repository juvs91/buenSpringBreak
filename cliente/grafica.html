<!DOCTYPE html>
<html ng-app>
	<head>
		<script type="text/javascript" src="plugins/jquery.min.js"></script> 
		<script src="plugins/highcharts.js"></script>     
		<script type="text/javascript" src="sensores.js" charset="utf-8"></script>                                                        
		<script type="text/javascript" src="point.js" charset="utf-8"></script>                 
		<script type="text/javascript" src="request.js" charset="utf-8"></script>   
	</head>
	<body id="body">
		<div id='container' ></div>
	</body>                        
	<script type="text/javascript" charset="utf-8">

	var sensoresJson = requestSensores();  
	var idLastPoint = 0;     
	var lastPointTemp = 0;
	var sensor; 
	var allSeries = [];   
	var chart; //variable chart para que se actualize en tiempo real 
	var shift;//la variable que se encarga si se tiene que mover la grafica  
	var mapeoIdSeries = {  }; //para saber que sensor corresponde a que posision del arreglo    
	var mapeoDeSensoresPuntos = { null:{}};


	for(var i = 0, t = sensoresJson.length; i < t; i++) {
		allSeries.push((creaSensor(sensoresJson[i],i)).getDataStructureGraph());
	} 
	chart = new Highcharts.Chart({
		chart :{
			renderTo :"container",
			defaultSeriesType: 'line',

		},
		title :{
			text : "todos los sensores"
		},
		xAxis :{
			type : "datetime", 
			tickPixelInterval: 150,
			maxZoom: 20 * 1000
		},
		yAxis : {
			minPadding : 0.2,
			maxPadding : 0.2,
			title : {
				text : "value",
				margin : 80
			}
		}, 
		series : allSeries,

	});          
	
	  
	//esta funcion tiene que llenar los puntos 
	function pushPoints(newPoints) { 
		console.log(newPoints);                 
		for (var i = 0; i < newPoints.length; i++) {
			//mueve la grafica o no 
			shift = chart.series[mapeoIdSeries[newPoints[i]["sensorTag"]["sensorTag"]]].data.length > 58; 
			//agrega los puntos a la grafica
			//tengo que agregar el punto a la serie y pasarle por parametro 
			chart.series[mapeoIdSeries[newPoints[i]["sensorTag"]["sensorTag"]]]
						.addPoint([newPoints[i]["insertDate"]
						,newPoints[i]["outputValue"]],shift,true); 
						
			idLastPoint = (newPoints[i]["idOutput"] > idLastPoint) ? newPoints[i]["idOutput"] : idLastPoint; 
		}                                                                                           

	}   
	
	    
	function addSeries (serie) {



		chart.addSeries();
   	}
	
	function llenaElSensoresPuntos(mapa) {
		
	}
  
	function creaSensor (sensorJson,posArreglo) {
		sensor =new Sensores();   
		sensor.setTag(sensorJson["sensor_tag"]);  
		if (sensorJson["sensor_tag"]) {
		  	sensor.setSensorName(sensorJson["sensor_tag"]); 
		}else{                             
			sensor.setSensorName("puntos sin sensor");
		}                                                
		llenaElSensoresPuntos(sensorJson);
   	    sensor.addPoint(sensorJson["slActualValue"]
						,sensorJson["slActualTimeStamp"]
						,sensorJson["slId"]
						,sensorJson["sensor_type"]);
		//slId tiene el ultimo punto de la tabla sensorlist				
	    idLastPoint = (sensorJson["slId"]  > idLastPoint) ? sensorJson["slId"]  : idLastPoint ; 
   		mapeoIdSeries[sensor.getTag()] = posArreglo;  
		return sensor;
	}	
	

		
	setInterval(function(){requestNewPoints(idLastPoint)},5000);

	</script>
</html>