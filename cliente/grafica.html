<!DOCTYPE html>
<html ng-app>
	<head>
		<script type="text/javascript" src="plugins/jquery.min.js"></script> 
		<script src="plugins/highcharts.js"></script>     
		<script type="text/javascript" src="sensores.js" charset="utf-8"></script>                                                        
		<script type="text/javascript" src="point.js" charset="utf-8"></script>                 
		<script type="text/javascript" src="request.js" charset="utf-8"></script>   
	</head>
	<body id="body">
		<div id='container' ></div>
	</body>                        
	<script type="text/javascript" charset="utf-8">

	var sensoresJson = requestSensores();  
	var idLastPoint = 0;     
	var lastPointTemp = 0;
	var sensor; 
	var allSeries = [];   
	var chart; //variable chart para que se actualize en tiempo real 
	var shift;//la variable que se encarga si se tiene que mover la grafica  
	var mapeoIdSeries = {  }; //para saber que sensor corresponde a que posision del arreglo     

	function creaSensor (sensorJson) {
		sensor =new Sensores();
		sensor.setTag(sensorJson["sensor_ID"]);
	  	sensor.setSensorName(sensorJson["sensorName"]);
		if (sensorJson["point"] != null) {
	       lastPointTemp = sensor.addPoints(sensorJson["point"]);
		   idLastPoint = (lastPointTemp > idLastPoint) ? lastPointTemp : idLastPoint ; 
	
		}    
		mapeoIdSeries[sensor.getTag()] = i;
		return sensor;
	}
	          
	//esta funcion tiene que llenar los puntos 
	function pushPoints(newPoints) { 
		console.log(newPoints);                 
		for (var i = 0; i < newPoints.length; i++) {
			//mueve la grafica o no 
			shift = chart.series[mapeoIdSeries[newPoints[i]["sensorTag"]["sensorTag"]]].data.length > 58; 
			//agrega los puntos a la grafica
			//tengo que agregar el punto a la serie y pasarle por parametro el add.Point de sensores y uego con los gets y sets del sensor para poder utilizar los datos para lo que pidio el doctor  
	chart.series[mapeoIdSeries[newPoints[i]["sensorTag"]["sensorTag"]]].addPoint([newPoints[i]["insertDate"],newPoints[i]["outputValue"]],shift,true); 
			    idLastPoint = (newPoints[i]["idOutput"] > idLastPoint) ? newPoints[i]["idOutput"] : idLastPoint; 
			}                                                                                           

	}
	
	function addSeries (serie) {



		chart.addSeries();
   }
   

	for(var i = 0, t = sensoresJson.length; i < t; i++) {
		allSeries.push((creaSensor(sensoresJson[i])).getDataStructureGraph());
	} 
	chart = new Highcharts.Chart({
		chart :{
			renderTo :"container",
			defaultSeriesType: 'line',
			events : {
				//load : requestNewPoints
			} 
		},
		title :{
			text : "todos los sensores"
		},
		xAxis :{
			type : "datetime", 
			tickPixelInterval: 150,
			maxZoom: 20 * 1000
		},
		yAxis : {
			minPadding : 0.2,
			maxPadding : 0.2,
			title : {
				text : "value",
				margin : 80
			}
		}, 
		series : allSeries,

	});      
		
	

		
	setInterval(function(){requestNewPoints(idLastPoint)},5000);

	</script>
</html>